<?php
/**
 * Magento
 *
 * NOTICE OF LICENSE
 *
 * This source file is subject to the Academic Free License (AFL 3.0)
 * that is bundled with this package in the file LICENSE_AFL.txt.
 * It is also available through the world-wide-web at this URL:
 * http://opensource.org/licenses/afl-3.0.php
 * If you did not receive a copy of the license and are unable to
 * obtain it through the world-wide-web, please send an email
 * to license@magentocommerce.com so we can send you a copy immediately.
 *
 * DISCLAIMER
 *
 * Do not edit or add to this file if you wish to upgrade Magento to newer
 * versions in the future. If you wish to customize Magento for your
 * needs please refer to http://www.magentocommerce.com for more information.
 *
 * @category    design
 * @package     default_default
 * @copyright   Copyright (c) 2013 Magento Inc. (http://www.magentocommerce.com)
 * @license     http://opensource.org/licenses/afl-3.0.php  Academic Free License (AFL 3.0)
 */
?>
<?php

    // check to see if the user has a secret shared, force QR code if not
    $user            = Mage::getSingleton('admin/session')->getUser();
    $admin_user      = Mage::getModel('admin/user')->load($user->getId());
    $secret          = $admin_user->getTwofactorGoogleSecret();

    if (!empty($secret)) {
        // $msg = Mage::helper('he_twofactorauth')->__('Please complete the Google two factor authentication');
        // Mage::getSingleton('adminhtml/session')->addNotice($msg);
    }
    else { 
        $g2fa = Mage::getModel("he_twofactorauth/validate_google");
        $secret = $g2fa->generateSecret();
        $qr_url = $g2fa->generateQRCodeUrl($secret, $user->getUsername());
        $msg = Mage::helper('he_twofactorauth')->__('You must set up your Google Authenticator app using the QR code below.');
        Mage::getSingleton('adminhtml/session')->addNotice($msg);  
        // TODO figure out message weirdness      
    }

?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html lang="en">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title><?php echo Mage::helper('adminhtml')->__('Google Two Factor Authentication'); ?></title>
    <link type="text/css" rel="stylesheet" href="<?php echo $this->getSkinUrl('reset.css'); ?>" media="all" />
    <link type="text/css" rel="stylesheet" href="<?php echo $this->getSkinUrl('boxes.css'); ?>" media="all" />
    <link rel="icon" href="<?php echo $this->getSkinUrl('favicon.ico'); ?>" type="image/x-icon" />
    <link rel="shortcut icon" href="<?php echo $this->getSkinUrl('favicon.ico'); ?>" type="image/x-icon" />

    <script type="text/javascript" src="<?php echo $this->getJsUrl(); ?>index.php/x.js?c=auto&f=prototype/prototype.js,prototype/validation.js,mage/adminhtml/events.js,mage/adminhtml/form.js,scriptaculous/effects.js"></script>
    <script type="text/javascript" src="<?php echo $this->getJsUrl('mage/captcha.js') ?>"></script>

    <!--[if IE]> <link rel="stylesheet" href="<?php echo $this->getSkinUrl('iestyles.css'); ?>" type="text/css" media="all" /> <![endif]-->
    <!--[if lt IE 7]> <link rel="stylesheet" href="<?php echo $this->getSkinUrl('below_ie7.css'); ?>" type="text/css" media="all" /> <![endif]-->
    <!--[if IE 7]> <link rel="stylesheet" href="<?php echo $this->getSkinUrl('ie7.css'); ?>" type="text/css" media="all" /> <![endif]-->
</head>
<body id="page-login">
<div class="login-container">
    <div class="login-box">
        <form method="post" action="<?php echo $this->getUrl('adminhtml/twofactor/verify') ?>" id="loginForm">
            <fieldset class="login-form">
                <input name="form_key" type="hidden" value="<?php echo $this->getFormKey(); ?>" />
                <h2><?php echo Mage::helper('adminhtml')->__('Please enter your One Time Password'); ?></h2>
                <div id="messages">
                    <?php echo $this->getMessagesBlock()->getGroupedHtml(); ?>
                </div>

                <?php if (!empty($qr_url)) {  // SHOW the QR code so they can set up their authenticator ?>                    

                    <p align='center'><img src="<?php echo $qr_url; ?>" /></p>
                    <input type="hidden" name="google_secret" value="<?php echo $secret; ?>"    />
                    <p><strong>To use this QR code in Google Authenticator</strong>:</p>
                    <ol>
                        <li>Start the app</li>
                        <li>Choose 'set up account' from the menu (top right corner)</li>
                        <li>Choose 'scan a barcode'</li>
                        <li>Point the camera at the QR code above</li>
                        <li>When the app tells you the secret has been saved, press the 'Continue' button below.</li>
                    </ol>

                <?php } else { // ... otherwise, show the input code field ?>
                    <div class="input-box forgot-password"><label for="input_code"><?php echo Mage::helper('adminhtml')->__('Security Code'); ?></label><br />
                        <input type="text" id="input_code" name="input_code" value="" class="required-entry input-text" style="width:461px;" />
                    </div>
                <?php } ?>

                <?php echo $this->getChildHtml('form.additional.info'); ?>

                <div class="clear"></div>
                <div class="form-buttons">
                    <a class="left" href="<?php echo $this->getUrl('adminhtml', array('_nosecret' => true)); ?>">&laquo; <?php echo Mage::helper('adminhtml')->__('Back to Login'); ?></a>
                    
                    <?php if (!empty($qr_url)) { ?>                    
                        <button class="forgot-password" onclick="loginForm.submit()" type="button"><span><span><span><?php echo Mage::helper('adminhtml')->__('Continue'); // TODO need better/clearer wording here? ?></span></span></span></button>
                    
                    <?php } else { ?>
                       
                        <button class="forgot-password" onclick="loginForm.submit()" type="button"><span><span><span><?php echo Mage::helper('adminhtml')->__('Submit Code'); ?></span></span></span></button>

                    <?php } ?>
                </div>
            </fieldset>
            <p class="legal"><?php echo Mage::helper('adminhtml')->__('Magento is a trademark of Magento Inc. Copyright &copy; %s Magento Inc.', date('Y')); ?></p>
        </form>
        <div class="bottom"></div>
        <script type="text/javascript">
            var loginForm = new varienForm('loginForm');
        </script>
    </div>
</div>
</body>
</html>

